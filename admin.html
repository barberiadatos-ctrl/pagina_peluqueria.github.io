<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel del Peluquero</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
    }

    h1 {
      text-align: center;
      color: #f5c518;
      margin-top: 2rem;
      font-size: 2rem;
    }

    button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background-color: #f5c518;
      border: none;
      color: #000;
      padding: 0.8rem 1.3rem;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #ffd700;
      transform: translateY(-2px);
    }

    .botones {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1.5rem auto;
    }

    .dia {
      margin: 2rem auto;
      background: #1e1e1e;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      max-width: 950px;
      overflow-x: auto;
      transition: all 0.3s ease;
    }

    .dia h2 {
      text-align: center;
      background-color: #f5c518;
      color: #111;
      margin: 0;
      padding: 0.8rem;
      border-radius: 12px 12px 0 0;
      font-size: 1.2rem;
      text-transform: capitalize;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
    }

    th, td {
      padding: 0.8rem;
      border-bottom: 1px solid #333;
    }

    th {
      background-color: #d4af37;
      color: #111;
      text-transform: uppercase;
      font-size: 0.9rem;
    }

    tr:nth-child(even) { background-color: #222; }
    tr:hover { background-color: #333; }

    footer {
      text-align: center;
      color: #aaa;
      margin-top: 3rem;
      padding-bottom: 1rem;
      font-size: 0.9rem;
    }

    #btnArriba {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background-color: #f5c518;
      color: #000;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 1.3rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      transition: 0.3s;
    }

    #btnArriba:hover {
      background-color: #ffd700;
      transform: scale(1.1);
    }

    .dia-futuro { box-shadow: 0 0 15px gold; border: 2px solid gold; }
    .dia-hoy { border: 2px solid #fff; box-shadow: 0 0 20px #fff; }
    .dia-pasado { opacity: 0.5; filter: grayscale(0.3); }

    .separador {
      text-align: center;
      margin: 3rem auto 1rem;
      font-size: 1.1rem;
      color: #f5c518;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-top: 1px solid #333;
      width: 85%;
      padding-top: 10px;
      opacity: 0.9;
    }

    .alerta-db {
      text-align: center;
      background-color: #f5c518;
      color: #000;
      padding: 1rem;
      border-radius: 0 0 12px 12px;
      font-weight: bold;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      margin-bottom: 1rem;
      display: none;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #f5c518;
      color: #000;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      font-weight: bold;
      animation: aparecer 0.5s ease forwards;
      z-index: 9999;
    }

    @keyframes aparecer {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <h1><i class="fa-solid fa-clipboard-list"></i> Panel del Peluquero</h1>
  <div id="alertaDB" class="alerta-db"></div>

  <div class="botones">
    <button id="actualizar"><i class="fa-solid fa-rotate"></i> Actualizar citas</button>
    <button onclick="window.location.href='index.html'"><i class="fa-solid fa-home"></i> Volver al inicio</button>
  </div>

  <div id="contenedorCitas"></div>
  <button id="btnArriba" title="Volver arriba"><i class="fa-solid fa-arrow-up"></i></button>

  <footer><span style="color:#f5c518;">Dorado Barber</span> — Panel de administración</footer>

  <script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://vukawliizqcjhptpyxdi.supabase.co";
const SUPABASE_KEY =
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1a2F3bGlpenFjamhwdHB5eGRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTEwMzksImV4cCI6MjA3Njg4NzAzOX0.XhH_NEwxiEaYqS4vZiWm4DjSXQ1bLZkMtdB0g8ewNtM";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const contenedor = document.getElementById("contenedorCitas");
const btnActualizar = document.getElementById("actualizar");
const btnArriba = document.getElementById("btnArriba");
const alertaDB = document.getElementById("alertaDB");

btnActualizar.addEventListener("click", cargarCitas);

const sonidoNotificacion = new Audio("jug-pop-2-186887.mp3");
sonidoNotificacion.volume = 0.7;

async function cargarCitas() {
  contenedor.innerHTML = "<p style='text-align:center;color:#bbb;'>Cargando citas...</p>";

  const { data: citas, error } = await supabase
    .from("citas")
    .select("*")
    .order("fecha", { ascending: true })
    .order("hora", { ascending: true });

  if (error) {
    contenedor.innerHTML = "<p style='text-align:center;color:red;'>Error al cargar citas</p>";
    return;
  }

  if (!citas.length) {
    contenedor.innerHTML = "<p style='text-align:center;color:#aaa;'>No hay citas registradas</p>";
    return;
  }

  const citasPorFecha = {};
  for (const cita of citas) {
    if (!citasPorFecha[cita.fecha]) citasPorFecha[cita.fecha] = [];
    citasPorFecha[cita.fecha].push(cita);
  }

  const ahora = new Date();
  const offset = ahora.getTimezoneOffset() * 60000;
  const local = new Date(ahora.getTime() - offset);
  const hoy = local.toISOString().split("T")[0];

  contenedor.innerHTML = "";

  const fechas = Object.keys(citasPorFecha).sort((a, b) => new Date(a) - new Date(b));
  const pasadas = [];
  const futuras = [];

  for (const f of fechas) {
    if (f < hoy) pasadas.push(f);
    else if (f > hoy) futuras.push(f);
  }

  if (citasPorFecha[hoy]) renderDia(hoy, citasPorFecha[hoy], "dia-hoy", "Hoy");
  if (futuras.length > 0) {
    const sep = document.createElement("div");
    sep.className = "separador";
    sep.textContent = "Próximos días";
    contenedor.appendChild(sep);
    futuras.forEach(f => renderDia(f, citasPorFecha[f], "dia-futuro"));
  }
  if (pasadas.length > 0) {
    const sep = document.createElement("div");
    sep.className = "separador";
    sep.textContent = "Días pasados";
    contenedor.appendChild(sep);
    pasadas.reverse().forEach(f => renderDia(f, citasPorFecha[f], "dia-pasado"));
  }

  verificarUsoBaseDatos();
}

function renderDia(fecha, lista, clase, tituloPersonalizado) {
  const fechaObj = new Date(fecha + "T00:00:00");
  const titulo = tituloPersonalizado || fechaObj.toLocaleDateString("es-ES", {
    weekday: "long", year: "numeric", month: "long", day: "numeric",
  });

  const div = document.createElement("div");
  div.className = `dia ${clase}`;
  div.innerHTML = `
    <h2>${titulo.charAt(0).toUpperCase() + titulo.slice(1)}</h2>
    <table>
      <thead>
        <tr><th>Cliente</th><th>Teléfono</th><th>Servicio</th><th>Hora</th></tr>
      </thead>
      <tbody>
        ${lista
          .sort((a, b) => a.hora.localeCompare(b.hora))
          .map(
            (c) => `<tr><td>${c.nombre}</td><td>${c.telefono}</td><td>${c.servicio}</td><td>${c.hora}</td></tr>`
          )
          .join("")}
      </tbody>
    </table>`;
  contenedor.appendChild(div);
}

async function verificarUsoBaseDatos() {
  const LIMITE = 10000, UMBRAL = 9000;
  const { count, error } = await supabase.from("citas").select("*", { count: "exact", head: true });
  if (error) return;
  if (count >= UMBRAL) {
    alertaDB.style.display = "block";
    alertaDB.innerHTML = `⚠️ <strong>Atención:</strong> Tu base tiene <strong>${count}</strong> registros (máx ${LIMITE}).`;
  } else alertaDB.style.display = "none";
}

window.addEventListener("scroll", () => {
  btnArriba.style.display = window.scrollY > 300 ? "flex" : "none";
});
btnArriba.addEventListener("click", () =>
  window.scrollTo({ top: 0, behavior: "smooth" })
);

function mostrarToast(mensaje) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = mensaje;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 5000);
}

supabase
  .channel("nuevas-citas")
  .on("postgres_changes", { event: "INSERT", schema: "public", table: "citas" }, (payload) => {
    sonidoNotificacion.play();
    mostrarToast(`Nuevo turno: ${payload.new.nombre} — ${payload.new.hora}`);
    cargarCitas();
  })
  .subscribe();

cargarCitas();
  </script>
</body>
</html>
